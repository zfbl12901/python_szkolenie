---
title: "Poetry"
order: 7.01.04
parent: "07-01-environnements.md"
tags: ["python", "poetry", "gestion-projet", "dependances"]
---

# Poetry

Poetry est un outil moderne pour la gestion de projets Python, combinant gestion de dépendances, packaging et publication. Il simplifie considérablement le workflow de développement Python.

## Concepts de base

**Poetry** est un outil tout-en-un qui remplace `pip`, `virtualenv`, `setup.py`, `setup.cfg`, et `requirements.txt`. Il utilise `pyproject.toml` comme fichier de configuration unique.

### Avantages de Poetry

- **Gestion unifiée** : Dépendances, environnement virtuel, et packaging dans un seul outil
- **Résolution de dépendances** : Résout automatiquement les conflits de versions
- **Lock file** : `poetry.lock` garantit la reproductibilité
- **Packaging intégré** : Crée facilement des packages distribuables
- **Publication** : Publie directement sur PyPI

## Installation et configuration

### Installation

```bash
# Installation avec pipx (recommandé)
pipx install poetry

# Ou avec le script officiel
curl -sSL https://install.python-poetry.org | python3 -

# Vérifier l'installation
poetry --version
```

### Initialisation d'un projet

```bash
# Créer un nouveau projet
poetry new mon-projet

# Structure créée
mon-projet/
├── pyproject.toml
├── README.md
├── mon_projet/
│   └── __init__.py
└── tests/
    └── __init__.py

# Ou initialiser un projet existant
cd projet-existant
poetry init
```

## pyproject.toml

### Structure de base

Le fichier `pyproject.toml` contient toute la configuration :

```toml
[tool.poetry]
name = "mon-projet"
version = "0.1.0"
description = "Description du projet"
authors = ["Votre Nom <email@example.com>"]
readme = "README.md"

[tool.poetry.dependencies]
python = "^3.8"
requests = "^2.25.0"
flask = "^2.0.0"

[tool.poetry.group.dev.dependencies]
pytest = "^7.0.0"
black = "^22.0.0"
mypy = "^0.950"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"
```

### Dépendances

```toml
[tool.poetry.dependencies]
# Version exacte
requests = "2.28.0"

# Version minimale
flask = ">=2.0.0"

# Plage de versions
django = ">=3.0,<4.0"

# Version compatible (caret)
numpy = "^1.20.0"  # >=1.20.0,<2.0.0

# Version compatible (tilde)
pandas = "~1.3.0"  # >=1.3.0,<1.4.0

# Dépendances optionnelles
package = {version = "^1.0.0", optional = true}

# Dépendances avec extras
requests = {version = "^2.25.0", extras = ["security"]}
```

### Groupes de dépendances

```toml
[tool.poetry.group.dev.dependencies]
pytest = "^7.0.0"
black = "^22.0.0"

[tool.poetry.group.test.dependencies]
pytest-cov = "^4.0.0"

[tool.poetry.group.docs.dependencies]
sphinx = "^5.0.0"
```

## Gestion des dépendances

### Ajouter des dépendances

```bash
# Ajouter une dépendance de production
poetry add requests

# Ajouter avec version spécifique
poetry add "flask>=2.0.0"

# Ajouter une dépendance de développement
poetry add --group dev pytest

# Ajouter plusieurs dépendances
poetry add requests flask django
```

### Supprimer des dépendances

```bash
# Supprimer une dépendance
poetry remove requests

# Supprimer une dépendance de développement
poetry remove --group dev pytest
```

### Mettre à jour

```bash
# Mettre à jour une dépendance
poetry update requests

# Mettre à jour toutes les dépendances
poetry update

# Mettre à jour le lock file sans installer
poetry lock --no-update
```

### Installer les dépendances

```bash
# Installer toutes les dépendances (production + dev)
poetry install

# Installer seulement les dépendances de production
poetry install --only main

# Installer avec un groupe spécifique
poetry install --with test
```

## Avantages par rapport à pip + venv

### Résolution de dépendances

```bash
# pip : peut installer des versions incompatibles
pip install package-a==1.0.0
pip install package-b==2.0.0  # ⚠️ Peut nécessiter package-a==2.0.0

# poetry : résout automatiquement les conflits
poetry add package-a==1.0.0
poetry add package-b==2.0.0  # ✅ Résout les conflits automatiquement
```

### Lock file

```bash
# pip : requirements.txt avec versions exactes (manuel)
pip freeze > requirements.txt

# poetry : lock file automatique
poetry lock  # Génère poetry.lock avec toutes les versions exactes
```

### Environnement virtuel intégré

```bash
# pip + venv : étapes manuelles
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# poetry : automatique
poetry install  # Crée l'environnement et installe tout
```

## Workflow complet

### 1. Créer un projet

```bash
# Nouveau projet
poetry new mon-projet
cd mon-projet

# Ou initialiser un projet existant
cd projet-existant
poetry init
```

### 2. Ajouter des dépendances

```bash
# Dépendances de production
poetry add requests flask

# Dépendances de développement
poetry add --group dev pytest black mypy
```

### 3. Développer

```bash
# Activer l'environnement
poetry shell

# Ou exécuter des commandes
poetry run python script.py
poetry run pytest
```

### 4. Build et publication

```bash
# Build du package
poetry build

# Publication sur PyPI
poetry publish

# Ou sur un dépôt privé
poetry publish --repository private-pypi
```

### Exemple complet

```bash
# 1. Créer le projet
poetry new mon-api
cd mon-api

# 2. Ajouter les dépendances
poetry add fastapi uvicorn
poetry add --group dev pytest black

# 3. Développer
poetry shell
# Écrire le code...

# 4. Tester
poetry run pytest

# 5. Formater
poetry run black .

# 6. Build
poetry build

# 7. Publier (optionnel)
poetry publish
```

## Commandes utiles

### Environnement virtuel

```bash
# Activer l'environnement
poetry shell

# Voir l'emplacement de l'environnement
poetry env info

# Exécuter une commande dans l'environnement
poetry run python script.py
poetry run pytest
```

### Informations

```bash
# Voir les dépendances
poetry show

# Voir une dépendance spécifique
poetry show requests

# Voir l'arbre des dépendances
poetry show --tree

# Voir les dépendances obsolètes
poetry show --outdated
```

### Configuration

```bash
# Voir la configuration
poetry config --list

# Configurer le répertoire des environnements virtuels
poetry config virtualenvs.path /path/to/venvs

# Désactiver la création automatique de venv
poetry config virtualenvs.create false
```

## Bonnes pratiques

### 1. Versionnez pyproject.toml et poetry.lock

```bash
# ✅ Versionner les deux fichiers
git add pyproject.toml
git add poetry.lock  # Important pour la reproductibilité
```

### 2. Utilisez des groupes pour organiser

```toml
# ✅ Organiser avec des groupes
[tool.poetry.group.dev.dependencies]
pytest = "^7.0.0"

[tool.poetry.group.test.dependencies]
pytest-cov = "^4.0.0"
```

### 3. Mettez à jour régulièrement

```bash
# ✅ Mettre à jour les dépendances
poetry update

# Vérifier les obsolètes
poetry show --outdated
```

### 4. Utilisez le lock file en production

```bash
# ✅ Production : utiliser le lock file
poetry install --no-dev  # Installe depuis poetry.lock
```

## Points clés à retenir

- ✅ Poetry combine **gestion de dépendances, environnement et packaging**
- ✅ Utilise `pyproject.toml` comme **fichier de configuration unique**
- ✅ Génère automatiquement `poetry.lock` pour la **reproductibilité**
- ✅ **Résout automatiquement** les conflits de dépendances
- ✅ **Environnement virtuel intégré** (création automatique)
- ✅ **Packaging et publication** intégrés
- ✅ Utilisez `poetry shell` pour activer l'environnement
- ✅ Versionnez **pyproject.toml ET poetry.lock**

Poetry modernise considérablement le workflow Python. Il simplifie la gestion des projets et réduit les erreurs liées aux dépendances. C'est devenu l'outil de choix pour de nombreux projets Python modernes.
